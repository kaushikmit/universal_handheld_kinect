<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style>
			#container {
				width: 100%;
				height: 100%;
			}
			#panorama {
		        width: 600px;
		        height: 400px;
		    }
		    #controls {
		        position: absolute;
		        bottom: 0;
		        z-index: 2;
		        text-align: center;
		        width: 100%;
		        padding-bottom: 3px;
		    }
		    .ctrl {
		        padding: 8px 5px;
		        width: 30px;
		        text-align: center;
		        background: rgba(200, 200, 200, 0.8);
		        display: inline-block;
		        cursor: pointer;
		    }
		    .ctrl:hover {
		        background: rgba(200, 200, 200, 1);
		    }
	</style>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://cdn.pannellum.org/2.3/pannellum.css"/>
	<script type="text/javascript" src="https://cdn.pannellum.org/2.3/pannellum.js"></script>
	<script src="/static/panaroma/three.min.js"></script>
	<script src="/static/panaroma/photo-sphere-viewer.min.js"></script>
	<script type="text/javascript">
		var uploadImage = function() {
			var form_data = new FormData($('#upload-file')[0]);
	        $.ajax({
	            type: 'POST',
	            url: '/uploadfile',
	            data: form_data,
	            contentType: false,
	            cache: false,
	            processData: false,
	            async: false,
	            success: function(data) {
	                DisplayPanaromicImage()
	            },
	            error: function(date) {
	            	console.log("error");
	            }
	        });
		}

		var DisplayPanaromicImage = function() {
			viewer = pannellum.viewer('panorama', {
		    	"type": "equirectangular",
		    	"panorama": "http://localhost:5000/static/my.jpg",
		    	"autoLoad": true
			});
			document.getElementById('pan-up').addEventListener('click', function(e) {
			    viewer.setPitch(viewer.getPitch() + 10);
			});
			document.getElementById('pan-down').addEventListener('click', function(e) {
			    viewer.setPitch(viewer.getPitch() - 10);
			});
			document.getElementById('pan-left').addEventListener('click', function(e) {
			    viewer.setYaw(viewer.getYaw() - 10);
			});
			document.getElementById('pan-right').addEventListener('click', function(e) {
			    viewer.setYaw(viewer.getYaw() + 10);
			});
			document.getElementById('zoom-in').addEventListener('click', function(e) {
			    viewer.setHfov(viewer.getHfov() - 10);
			});
			document.getElementById('zoom-out').addEventListener('click', function(e) {
			    viewer.setHfov(viewer.getHfov() + 10);
			});
			document.getElementById('fullscreen').addEventListener('click', function(e) {
			    viewer.toggleFullscreen();
			});
			
			$(document).ready(function(){
                namespace = '/model'; // change to an empty string to use the global namespace

                // the socket.io documentation recommends sending an explicit package upon connection
                // this is specially important when using the global namespace
                var socket = io.connect('http://' + document.domain + ':' + location.port + namespace);
                socket.on('connect', function() {
                	console.log("connected");
                    socket.emit('my event', {data: 'I\'m connected!'});

                });

                socket.on('model::GYRO_STREAM', function(message){

                    var _obj = message.split(",");

                    _obj[0] = (parseFloat(_obj[0])/180)*Math.PI; // 0-360
                    _obj[1] = (parseFloat(_obj[1])/180)*Math.PI; // -180 - 180
                    _obj[2] = (parseFloat(_obj[2])/180)*Math.PI; // -90 - 90

                    var quaternion = new THREE.Quaternion();
                    quaternion.setFromEuler(new THREE.Vector3(_obj[0], _obj[1], _obj[2]), 'XYZ');

                    Object.keys(meshes).forEach(function(key) {

                        meshes[key].useQuaternion = true;
                        meshes[key].quaternion = quaternion;

                    });

                });

                socket.on('model::COMMANDS', function(message){

                    if(message == "CLEAR_MODEL"){
                        clearModel();
                    }else if(message == "RESET_MODEL"){
                        resetModel();
                    }else{
                        setZoom(parseFloat(message.split(",")[1]));
                    }

                });
            });
		}
	</script>
</head>
<body>
	<form id="upload-file" enctype="multipart/form-data" onsubmit="event.preventDefault()">
	    Select image to upload:
	    <input type="file" name="file">
	    <button value="Upload Image" onclick="uploadImage()"></button>
	</form>
	<div id="panorama">
		<div id="controls">
	        <div class="ctrl" id="pan-up">up</div>
	        <div class="ctrl" id="pan-down">down</div>
	        <div class="ctrl" id="pan-left">left</div>
	        <div class="ctrl" id="pan-right">right</div>
	        <div class="ctrl" id="zoom-in">plus</div>
	        <div class="ctrl" id="zoom-out">minus</div>
	        <div class="ctrl" id="fullscreen">fullscreen</div>
    	</div>
	</div>

	
<script type="text/javascript">
	/*var div = document.getElementById('container');
			var PSV = new PhotoSphereViewer({
					panorama: 'http://localhost:5000/static/my.jpg',
					container: div,
					time_anim: 3000,
					navbar: true,
					navbar_style: {
						backgroundColor: 'rgba(58, 67, 77, 0.7)'
					},
				});
	viewer = pannellum.viewer('panorama', {
    	"type": "equirectangular",
    	"panorama": "http://localhost:5000/static/my.jpg",
    	"autoLoad": true
	});
	document.getElementById('pan-up').addEventListener('click', function(e) {
	    viewer.setPitch(viewer.getPitch() + 10);
	});
	document.getElementById('pan-down').addEventListener('click', function(e) {
	    viewer.setPitch(viewer.getPitch() - 10);
	});
	document.getElementById('pan-left').addEventListener('click', function(e) {
	    viewer.setYaw(viewer.getYaw() - 10);
	});
	document.getElementById('pan-right').addEventListener('click', function(e) {
	    viewer.setYaw(viewer.getYaw() + 10);
	});
	document.getElementById('zoom-in').addEventListener('click', function(e) {
	    viewer.setHfov(viewer.getHfov() - 10);
	});
	document.getElementById('zoom-out').addEventListener('click', function(e) {
	    viewer.setHfov(viewer.getHfov() + 10);
	});
	document.getElementById('fullscreen').addEventListener('click', function(e) {
	    viewer.toggleFullscreen();
	});*/
</script>
</body>
</html>